# 数据库初始化指南

## 📋 概述

本指南介绍如何初始化学术研究知识图谱系统的数据库，包括MySQL和Neo4j两个数据库。

---

## 🗄️ MySQL数据库初始化

### 前置要求

- MySQL 8.0 或更高版本
- 数据库管理员权限
- 字符集支持：utf8mb4

### 方法1：使用SQL脚本（推荐）

#### 步骤1：登录MySQL

```bash
# Windows
mysql -u root -p

# Linux/Mac
sudo mysql -u root -p
```

#### 步骤2：执行初始化脚本

```bash
# 在MySQL命令行中执行
mysql> source D:/My_Python_Project/graduationProject/scripts/init_mysql_schema.sql;

# 或者在命令行直接执行
mysql -u root -p < scripts/init_mysql_schema.sql
```

#### 步骤3：验证初始化结果

```sql
-- 切换到新建的数据库
USE knowledge_graph_system;

-- 查看所有表
SHOW TABLES;

-- 查看表结构（示例）
DESCRIBE users;
DESCRIBE research_sessions;
DESCRIBE chat_messages;
DESCRIBE papers;

-- 查看索引
SHOW INDEX FROM users;
SHOW INDEX FROM chat_messages;

-- 查看触发器
SHOW TRIGGERS;
```

预期输出：
```
+----------------------------+
| Tables_in_knowledge_graph_ |
+----------------------------+
| chat_messages              |
| papers                     |
| research_sessions          |
| users                      |
+----------------------------+
4 rows in set (0.00 sec)
```

### 方法2：使用Alembic迁移（推荐用于生产环境）

#### 步骤1：安装Alembic

```bash
pip install alembic
```

#### 步骤2：初始化Alembic（如果还未初始化）

```bash
alembic init alembic
```

#### 步骤3：配置alembic.ini

```ini
# alembic.ini
sqlalchemy.url = mysql+pymysql://root:password@localhost/knowledge_graph_system?charset=utf8mb4
```

#### 步骤4：创建迁移脚本

```bash
# 创建新的迁移版本
alembic revision -m "initial_schema"

# 编辑生成的迁移文件（在alembic/versions/目录下）
# 将init_mysql_schema.sql中的CREATE TABLE语句转换为SQLAlchemy代码
```

#### 步骤5：执行迁移

```bash
# 升级到最新版本
alembic upgrade head

# 查看迁移历史
alembic history

# 回滚（如果需要）
alembic downgrade -1
```

---

## 📊 Neo4j图数据库初始化

### 前置要求

- Neo4j 5.0 或更高版本
- Neo4j Desktop 或 Neo4j Server
- 数据库管理员权限

### 方法1：使用cypher-shell（推荐）

#### 步骤1：启动Neo4j

```bash
# 使用Neo4j Desktop：直接在界面中启动数据库

# 使用Neo4j Server（命令行）
neo4j start
```

#### 步骤2：连接到cypher-shell

```bash
# 连接到Neo4j
cypher-shell -u neo4j -p your_password

# 或者指定地址
cypher-shell -a bolt://localhost:7687 -u neo4j -p your_password
```

#### 步骤3：执行初始化脚本

```bash
# 在cypher-shell中执行
neo4j> :source D:/My_Python_Project/graduationProject/scripts/init_neo4j_schema.cypher

# 或者在命令行直接执行
cat scripts/init_neo4j_schema.cypher | cypher-shell -u neo4j -p your_password
```

#### 步骤4：验证初始化结果

```cypher
// 查看所有约束
SHOW CONSTRAINTS;

// 查看所有索引
SHOW INDEXES;

// 查看数据库统计
CALL db.stats.retrieve('GRAPH COUNTS');

// 查看所有节点标签
CALL db.labels();

// 查看所有关系类型
CALL db.relationshipTypes();
```

预期输出：
```
约束列表：
- entity_uuid (UNIQUENESS)
- episode_uuid (UNIQUENESS)
- community_uuid (UNIQUENESS)

索引列表：
- node_group_id (BTREE)
- episode_group_id (BTREE)
- community_group_id (BTREE)
- entity_name (BTREE)
- entity_domain (BTREE)
- entity_name_fulltext (FULLTEXT)
- episode_content_fulltext (FULLTEXT)
```

### 方法2：使用Neo4j Browser

#### 步骤1：打开Neo4j Browser

在浏览器中访问：`http://localhost:7474`

#### 步骤2：登录

- 用户名：`neo4j`
- 密码：你设置的密码

#### 步骤3：执行Cypher脚本

1. 打开 `scripts/init_neo4j_schema.cypher` 文件
2. 复制所有内容
3. 在Neo4j Browser的查询框中粘贴
4. 点击"运行"按钮（或按 Ctrl+Enter）

---

## 🔧 配置应用程序连接

### Python配置（app/core/config.py）

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # MySQL配置
    MYSQL_HOST: str = "localhost"
    MYSQL_PORT: int = 3306
    MYSQL_USER: str = "root"
    MYSQL_PASSWORD: str = "your_password"
    MYSQL_DATABASE: str = "knowledge_graph_system"
    
    # Neo4j配置
    NEO4J_URI: str = "bolt://localhost:7687"
    NEO4J_USER: str = "neo4j"
    NEO4J_PASSWORD: str = "your_password"
    
    # 数据库URL
    @property
    def DATABASE_URL(self) -> str:
        return f"mysql+pymysql://{self.MYSQL_USER}:{self.MYSQL_PASSWORD}@{self.MYSQL_HOST}:{self.MYSQL_PORT}/{self.MYSQL_DATABASE}?charset=utf8mb4"
    
    class Config:
        env_file = ".env"

settings = Settings()
```

### 环境变量配置（.env）

```env
# MySQL配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=knowledge_graph_system

# Neo4j配置
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_password

# JWT密钥
SECRET_KEY=your-secret-key-here-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

---

## 🧪 测试数据库连接

### 测试MySQL连接

创建测试脚本 `scripts/test_mysql_connection.py`：

```python
import pymysql
from app.core.config import settings

def test_mysql_connection():
    try:
        connection = pymysql.connect(
            host=settings.MYSQL_HOST,
            port=settings.MYSQL_PORT,
            user=settings.MYSQL_USER,
            password=settings.MYSQL_PASSWORD,
            database=settings.MYSQL_DATABASE,
            charset='utf8mb4'
        )
        
        with connection.cursor() as cursor:
            cursor.execute("SHOW TABLES;")
            tables = cursor.fetchall()
            print("✅ MySQL连接成功！")
            print(f"数据库: {settings.MYSQL_DATABASE}")
            print(f"表数量: {len(tables)}")
            print("表列表:")
            for table in tables:
                print(f"  - {table[0]}")
        
        connection.close()
        return True
    
    except Exception as e:
        print(f"❌ MySQL连接失败: {e}")
        return False

if __name__ == "__main__":
    test_mysql_connection()
```

运行测试：
```bash
python scripts/test_mysql_connection.py
```

### 测试Neo4j连接

创建测试脚本 `scripts/test_neo4j_connection.py`：

```python
from neo4j import GraphDatabase
from app.core.config import settings

def test_neo4j_connection():
    try:
        driver = GraphDatabase.driver(
            settings.NEO4J_URI,
            auth=(settings.NEO4J_USER, settings.NEO4J_PASSWORD)
        )
        
        with driver.session() as session:
            result = session.run("RETURN 'Hello Neo4j' AS message")
            message = result.single()["message"]
            print(f"✅ Neo4j连接成功！")
            print(f"消息: {message}")
            
            # 查看约束
            result = session.run("SHOW CONSTRAINTS")
            constraints = list(result)
            print(f"约束数量: {len(constraints)}")
            
            # 查看索引
            result = session.run("SHOW INDEXES")
            indexes = list(result)
            print(f"索引数量: {len(indexes)}")
        
        driver.close()
        return True
    
    except Exception as e:
        print(f"❌ Neo4j连接失败: {e}")
        return False

if __name__ == "__main__":
    test_neo4j_connection()
```

运行测试：
```bash
python scripts/test_neo4j_connection.py
```

---

## 📦 数据库备份与恢复

### MySQL备份

#### 备份整个数据库

```bash
# 完整备份
mysqldump -u root -p knowledge_graph_system > backup_$(date +%Y%m%d_%H%M%S).sql

# 备份结构和数据
mysqldump -u root -p --single-transaction --quick knowledge_graph_system > backup_full.sql

# 只备份结构
mysqldump -u root -p --no-data knowledge_graph_system > backup_schema_only.sql

# 只备份数据
mysqldump -u root -p --no-create-info knowledge_graph_system > backup_data_only.sql
```

#### 备份特定表

```bash
mysqldump -u root -p knowledge_graph_system users research_sessions > backup_users_sessions.sql
```

#### 恢复备份

```bash
# 恢复整个数据库
mysql -u root -p knowledge_graph_system < backup_20251211_120000.sql

# 恢复特定表
mysql -u root -p knowledge_graph_system < backup_users_sessions.sql
```

### Neo4j备份

#### 使用neo4j-admin备份

```bash
# 停止Neo4j
neo4j stop

# 备份数据库
neo4j-admin dump --database=neo4j --to=/backup/neo4j_backup_$(date +%Y%m%d).dump

# 启动Neo4j
neo4j start
```

#### 恢复备份

```bash
# 停止Neo4j
neo4j stop

# 恢复数据库
neo4j-admin load --from=/backup/neo4j_backup_20251211.dump --database=neo4j --force

# 启动Neo4j
neo4j start
```

#### 导出Cypher脚本（需要APOC插件）

```cypher
// 导出所有数据为Cypher脚本
CALL apoc.export.cypher.all('/backup/export_all.cypher', {
    format: 'cypher-shell',
    useOptimizations: {type: 'UNWIND_BATCH', unwindBatchSize: 20}
});

// 导出特定用户的数据
CALL apoc.export.cypher.query(
    "MATCH (n) WHERE n.group_id = '550e8400-e29b-41d4-a716-446655440000' RETURN n",
    '/backup/export_user.cypher',
    {}
);
```

---

## 🔍 常见问题与排查

### 问题1：MySQL字符集错误

**错误信息**：
```
ERROR 1115 (42000): Unknown character set: 'utf8mb4'
```

**解决方案**：
```sql
-- 检查MySQL版本
SELECT VERSION();

-- 确保MySQL 5.5.3+
-- 如果版本过低，升级MySQL或使用utf8字符集
```

### 问题2：Neo4j约束冲突

**错误信息**：
```
Neo.ClientError.Schema.ConstraintValidationFailed
```

**解决方案**：
```cypher
// 删除旧约束
DROP CONSTRAINT entity_uuid IF EXISTS;

// 清理重复数据
MATCH (n:EntityNode)
WITH n.uuid as uuid, collect(n) as nodes
WHERE size(nodes) > 1
FOREACH (n in tail(nodes) | DETACH DELETE n);

// 重新创建约束
CREATE CONSTRAINT entity_uuid IF NOT EXISTS
FOR (n:EntityNode) REQUIRE n.uuid IS UNIQUE;
```

### 问题3：外键约束错误

**错误信息**：
```
ERROR 1452 (23000): Cannot add or update a child row: a foreign key constraint fails
```

**解决方案**：
```sql
-- 临时禁用外键检查
SET FOREIGN_KEY_CHECKS = 0;

-- 执行操作...

-- 重新启用外键检查
SET FOREIGN_KEY_CHECKS = 1;
```

### 问题4：触发器创建失败

**错误信息**：
```
ERROR 1419 (HY000): You do not have the SUPER privilege
```

**解决方案**：
```sql
-- 设置log_bin_trust_function_creators
SET GLOBAL log_bin_trust_function_creators = 1;

-- 或在my.cnf中添加
[mysqld]
log_bin_trust_function_creators = 1
```

---

## ✅ 初始化检查清单

### MySQL初始化检查

- [ ] MySQL服务已启动
- [ ] 数据库 `knowledge_graph_system` 已创建
- [ ] 4张表已创建：users, research_sessions, chat_messages, papers
- [ ] 所有索引已创建
- [ ] 外键约束已添加
- [ ] 触发器已创建（如果启用）
- [ ] 测试连接成功

### Neo4j初始化检查

- [ ] Neo4j服务已启动
- [ ] 3个唯一约束已创建（entity_uuid, episode_uuid, community_uuid）
- [ ] 7个以上索引已创建
- [ ] 全文索引已创建（entity_name_fulltext, episode_content_fulltext）
- [ ] 测试连接成功

### 应用配置检查

- [ ] .env文件已配置
- [ ] 数据库连接信息正确
- [ ] SECRET_KEY已设置（生产环境必须更换）
- [ ] 测试脚本运行成功

---

## 📚 相关文档

- [数据库Schema设计.md](../需求文档/数据库Schema设计.md) - 完整的数据库设计文档
- [PRD_API总览.md](../需求文档/PRD_API总览.md) - API接口总览
- [使用Alembic迁移指南.md](../需求文档/使用Alembic迁移指南.md) - 数据库迁移指南

---

## 🆘 获取帮助

如果遇到问题，请：

1. 查看本指南的"常见问题与排查"部分
2. 检查MySQL和Neo4j的日志文件
3. 确认数据库版本符合要求
4. 联系项目负责人

---

**文档版本**：v1.0  
**最后更新**：2025-12-11

